name: Deploy Demo Instance

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Build and Push Docker Image"]
    types:
      - completed
    branches:
      - main

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Only run if triggered by workflow_dispatch or if build workflow succeeded
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch || github.ref }}

      - name: Install and connect to Tailscale
        env:
          TS_AUTHKEY: ${{ secrets.SLUGBASE_DEMO_TS_KEY }}
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey="$TS_AUTHKEY" --accept-routes
          # Wait for Tailscale to establish connection
          sleep 5

      - name: Configure SSH
        env:
          DEMO_HOSTNAME: ${{ secrets.SLUGBASE_DEMO_HOSTNAME }}
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          # Resolve Tailscale hostname for SSH
          ssh-keyscan -H $DEMO_HOSTNAME >> ~/.ssh/known_hosts || true

      - name: Generate random secrets
        id: secrets
        run: |
          echo "jwt_secret=$(openssl rand -base64 48 | tr -d '\n')" >> $GITHUB_OUTPUT
          echo "encryption_key=$(openssl rand -hex 32 | tr -d '\n')" >> $GITHUB_OUTPUT
          echo "session_secret=$(openssl rand -base64 48 | tr -d '\n')" >> $GITHUB_OUTPUT

      - name: Create deployment script
        run: |
          cat > /tmp/deploy.sh << 'SCRIPT'
          #!/bin/bash
          set -e
          
          REGISTRY="$1"
          IMAGE_NAME="$2"
          GITHUB_TOKEN="$3"
          GITHUB_ACTOR="$4"
          JWT_SECRET="$5"
          ENCRYPTION_KEY="$6"
          SESSION_SECRET="$7"
          TS_AUTHKEY="$8"
          DEMO_HOSTNAME="$9"
          
          echo "Logging in to GitHub Container Registry..."
          echo "$GITHUB_TOKEN" | docker login $REGISTRY -u $GITHUB_ACTOR --password-stdin
          
          echo "Pulling latest image..."
          docker pull $REGISTRY/$IMAGE_NAME:latest
          
          echo "Stopping existing container..."
          docker stop slugbase-demo 2>/dev/null || true
          docker rm slugbase-demo 2>/dev/null || true
          
          echo "Creating Docker volume if it doesn't exist..."
          docker volume create slugbase-demo-db 2>/dev/null || true
          
          echo "Starting new container..."
          docker run -d \
            --name slugbase-demo \
            --restart unless-stopped \
            -p 5000:5000 \
            -v slugbase-demo-db:/app/data \
            -e NODE_ENV=production \
            -e PORT=5000 \
            -e DB_TYPE=sqlite \
            -e DB_PATH=/app/data/slugbase.db \
            -e DEMO_MODE=true \
            -e DEMO_RESET_SCHEDULE="0 * * * *" \
            -e JWT_SECRET="$JWT_SECRET" \
            -e ENCRYPTION_KEY="$ENCRYPTION_KEY" \
            -e SESSION_SECRET="$SESSION_SECRET" \
            -e BASE_URL="https://demo.slugbase.ghotso.dev" \
            -e FRONTEND_URL="https://demo.slugbase.ghotso.dev" \
            -e TS_AUTHKEY="$TS_AUTHKEY" \
            $REGISTRY/$IMAGE_NAME:latest
          
          echo "Waiting for container to start..."
          sleep 5
          
          echo "Checking container status..."
          if docker ps | grep -q slugbase-demo; then
            echo "✓ Container is running"
          else
            echo "✗ Container failed to start"
            docker logs slugbase-demo || true
            exit 1
          fi
          SCRIPT
          chmod +x /tmp/deploy.sh

      - name: Deploy to server
        env:
          DEMO_HOSTNAME: ${{ secrets.SLUGBASE_DEMO_HOSTNAME }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          scp /tmp/deploy.sh $SSH_USER@$DEMO_HOSTNAME:/tmp/deploy.sh
          ssh $SSH_USER@$DEMO_HOSTNAME bash /tmp/deploy.sh \
            "${{ env.REGISTRY }}" \
            "${{ env.IMAGE_NAME }}" \
            "${{ secrets.GITHUB_TOKEN }}" \
            "${{ github.actor }}" \
            "${{ steps.secrets.outputs.jwt_secret }}" \
            "${{ steps.secrets.outputs.encryption_key }}" \
            "${{ steps.secrets.outputs.session_secret }}" \
            "${{ secrets.SLUGBASE_DEMO_TS_KEY }}" \
            "${{ secrets.SLUGBASE_DEMO_HOSTNAME }}"

      - name: Verify deployment
        env:
          DEMO_HOSTNAME: ${{ secrets.SLUGBASE_DEMO_HOSTNAME }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          sleep 10
          ssh $SSH_USER@$DEMO_HOSTNAME bash << 'EOF'
            echo "Verifying deployment..."
            if docker ps | grep -q slugbase-demo; then
              echo "✓ Container is running"
              echo ""
              echo "Container logs (last 50 lines):"
              docker logs --tail 50 slugbase-demo
              echo ""
              echo "✓ Demo instance deployed successfully!"
              echo ""
              echo "Configuration:"
              echo "  - DEMO_MODE: enabled"
              echo "  - Reset schedule: Every hour (0 * * * *)"
              echo "  - Database: Docker volume (slugbase-demo-db)"
            else
              echo "✗ Container is not running"
              echo ""
              echo "Container logs:"
              docker logs slugbase-demo 2>&1 || true
              exit 1
            fi
          EOF
