import { Router } from 'express';
import { query, queryOne } from '../db/index.js';
import { requireAuth, AuthRequest } from '../middleware/auth.js';

const router = Router();

/**
 * @swagger
 * /api/dashboard/stats:
 *   get:
 *     summary: Get dashboard statistics
 *     description: Returns statistics for the authenticated user's dashboard
 *     tags: [Dashboard]
 *     security:
 *       - cookieAuth: []
 *       - bearerAuth: []
 *     responses:
 *       200:
 *         description: Dashboard statistics
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 totalBookmarks:
 *                   type: number
 *                 totalFolders:
 *                   type: number
 *                 totalTags:
 *                   type: number
 *                 sharedBookmarks:
 *                   type: number
 *                 sharedFolders:
 *                   type: number
 *                 recentBookmarks:
 *                   type: array
 *                 topTags:
 *                   type: array
 *       401:
 *         description: Unauthorized
 */
router.get('/stats', requireAuth, async (req, res) => {
  const authReq = req as AuthRequest;
  try {
    const userId = authReq.user!.id;

    // Get user's teams
    const userTeams = await query(
      'SELECT team_id FROM team_members WHERE user_id = ?',
      [userId]
    );
    const teamIds = Array.isArray(userTeams) ? userTeams.map((t: any) => t.team_id) : [];

    // Total bookmarks (own only)
    const totalBookmarksResult = await queryOne(
      'SELECT COUNT(*) as count FROM bookmarks WHERE user_id = ?',
      [userId]
    );
    const totalBookmarks = totalBookmarksResult ? parseInt((totalBookmarksResult as any).count) : 0;

    // Total folders (own only)
    const totalFoldersResult = await queryOne(
      'SELECT COUNT(*) as count FROM folders WHERE user_id = ?',
      [userId]
    );
    const totalFolders = totalFoldersResult ? parseInt((totalFoldersResult as any).count) : 0;

    // Total tags (own only)
    const totalTagsResult = await queryOne(
      'SELECT COUNT(*) as count FROM tags WHERE user_id = ?',
      [userId]
    );
    const totalTags = totalTagsResult ? parseInt((totalTagsResult as any).count) : 0;

    // Shared bookmarks count (bookmarks shared with user)
    // Use simpler queries that don't cause cartesian products
    const sharedBookmarkIds = new Set<string>();
    
    // Direct user shares
    const userSharedBookmarks = await query(
      'SELECT DISTINCT bookmark_id FROM bookmark_user_shares WHERE user_id = ?',
      [userId]
    );
    (Array.isArray(userSharedBookmarks) ? userSharedBookmarks : []).forEach((row: any) => {
      if (row.bookmark_id) sharedBookmarkIds.add(row.bookmark_id);
    });
    
    // Team shares
    if (teamIds.length > 0) {
      const teamSharedBookmarks = await query(
        `SELECT DISTINCT bookmark_id FROM bookmark_team_shares WHERE team_id IN (${teamIds.map(() => '?').join(',')})`,
        teamIds
      );
      (Array.isArray(teamSharedBookmarks) ? teamSharedBookmarks : []).forEach((row: any) => {
        if (row.bookmark_id) sharedBookmarkIds.add(row.bookmark_id);
      });
    }
    
    // Folder user shares
    const folderUserShares = await query(
      'SELECT DISTINCT folder_id FROM folder_user_shares WHERE user_id = ?',
      [userId]
    );
    if (Array.isArray(folderUserShares) && folderUserShares.length > 0) {
      const folderIds = folderUserShares.map((row: any) => row.folder_id).filter(Boolean);
      if (folderIds.length > 0) {
        const bookmarkFolderShares = await query(
          `SELECT DISTINCT bookmark_id FROM bookmark_folders WHERE folder_id IN (${folderIds.map(() => '?').join(',')})`,
          folderIds
        );
        (Array.isArray(bookmarkFolderShares) ? bookmarkFolderShares : []).forEach((row: any) => {
          if (row.bookmark_id) sharedBookmarkIds.add(row.bookmark_id);
        });
      }
    }
    
    // Folder team shares
    if (teamIds.length > 0) {
      const folderTeamShares = await query(
        `SELECT DISTINCT folder_id FROM folder_team_shares WHERE team_id IN (${teamIds.map(() => '?').join(',')})`,
        teamIds
      );
      if (Array.isArray(folderTeamShares) && folderTeamShares.length > 0) {
        const folderIds = folderTeamShares.map((row: any) => row.folder_id).filter(Boolean);
        if (folderIds.length > 0) {
          const bookmarkFolderShares = await query(
            `SELECT DISTINCT bookmark_id FROM bookmark_folders WHERE folder_id IN (${folderIds.map(() => '?').join(',')})`,
            folderIds
          );
          (Array.isArray(bookmarkFolderShares) ? bookmarkFolderShares : []).forEach((row: any) => {
            if (row.bookmark_id) sharedBookmarkIds.add(row.bookmark_id);
          });
        }
      }
    }
    
    // Filter out own bookmarks and count
    const sharedBookmarkIdsArray = Array.from(sharedBookmarkIds);
    let sharedBookmarks = 0;
    if (sharedBookmarkIdsArray.length > 0) {
      const sharedBookmarksResult = await queryOne(
        `SELECT COUNT(*) as count FROM bookmarks WHERE id IN (${sharedBookmarkIdsArray.map(() => '?').join(',')}) AND user_id != ?`,
        [...sharedBookmarkIdsArray, userId]
      );
      sharedBookmarks = sharedBookmarksResult ? parseInt((sharedBookmarksResult as any).count) : 0;
    }

    // Shared folders count (folders shared with user)
    const sharedFolderIds = new Set<string>();
    
    // Direct user shares
    const userSharedFolders = await query(
      'SELECT DISTINCT folder_id FROM folder_user_shares WHERE user_id = ?',
      [userId]
    );
    (Array.isArray(userSharedFolders) ? userSharedFolders : []).forEach((row: any) => {
      if (row.folder_id) sharedFolderIds.add(row.folder_id);
    });
    
    // Team shares
    if (teamIds.length > 0) {
      const teamSharedFolders = await query(
        `SELECT DISTINCT folder_id FROM folder_team_shares WHERE team_id IN (${teamIds.map(() => '?').join(',')})`,
        teamIds
      );
      (Array.isArray(teamSharedFolders) ? teamSharedFolders : []).forEach((row: any) => {
        if (row.folder_id) sharedFolderIds.add(row.folder_id);
      });
    }
    
    // Filter out own folders and count
    const sharedFolderIdsArray = Array.from(sharedFolderIds);
    let sharedFolders = 0;
    if (sharedFolderIdsArray.length > 0) {
      const sharedFoldersResult = await queryOne(
        `SELECT COUNT(*) as count FROM folders WHERE id IN (${sharedFolderIdsArray.map(() => '?').join(',')}) AND user_id != ?`,
        [...sharedFolderIdsArray, userId]
      );
      sharedFolders = sharedFoldersResult ? parseInt((sharedFoldersResult as any).count) : 0;
    }

    // Recent bookmarks (last 5, own only)
    const recentBookmarks = await query(
      'SELECT id, title, url, created_at FROM bookmarks WHERE user_id = ? ORDER BY created_at DESC LIMIT 5',
      [userId]
    );
    const recentBookmarksList = Array.isArray(recentBookmarks) ? recentBookmarks : (recentBookmarks ? [recentBookmarks] : []);

    // Top tags (most used, top 5)
    const topTags = await query(
      `SELECT t.id, t.name, COUNT(bt.bookmark_id) as bookmark_count
       FROM tags t
       INNER JOIN bookmark_tags bt ON t.id = bt.tag_id
       INNER JOIN bookmarks b ON bt.bookmark_id = b.id
       WHERE t.user_id = ?
       GROUP BY t.id, t.name
       ORDER BY bookmark_count DESC
       LIMIT 5`,
      [userId]
    );
    const topTagsList = Array.isArray(topTags) ? topTags : (topTags ? [topTags] : []);

    res.json({
      totalBookmarks,
      totalFolders,
      totalTags,
      sharedBookmarks,
      sharedFolders,
      recentBookmarks: recentBookmarksList,
      topTags: topTagsList,
    });
  } catch (error: any) {
    res.status(500).json({ error: error.message });
  }
});

export default router;
